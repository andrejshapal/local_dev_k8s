---
- name: Install Proxy
  hosts: zabbix-proxy
  vars:
    ansible_user: root
    ansible_become: false
  roles:
    - role: community.zabbix.zabbix_proxy
      zabbix_proxy_server: host.docker.internal:8081
      zabbix_proxy_database: sqlite3
      zabbix_proxy_dbname: /var/lib/zabbix/db/sqlite3.db
      zabbix_proxy_pidfile: /var/run/zabbix/zabbix_proxy.pid
      zabbix_proxy_debuglevel: 4

- name: Configure SNMP Simulator
  hosts: proxy
  vars:
    ansible_user: root
    ansible_become: false

  tasks:

    - name: Fix SQLite DB ownership and permissions
      ansible.builtin.file:
        path: /var/lib/zabbix/db/sqlite3.db
        owner: zabbix
        group: zabbix
        mode: '0644'

    - name: Install snmpsim
      ansible.builtin.pip:
        name: snmpsim

    - name: Ensure /tmp/data dir exists
      file:
        path: "/tmp/data/{{ item }}"
        state: directory
      loop:
        - 1161
        - 1162

    - name: Copy test data
      ansible.builtin.copy:
        src: "{{ item }}.snmprec"
        dest: "/tmp/data/{{ item }}/public.snmprec"
      loop:
        - 1161
        - 1162


    - name: Stop snmpsim if running
      ansible.builtin.shell: |
        if [ -f /tmp/snmpsim_{{ item }}.pid ] && kill -0 $(cat /tmp/snmpsim_{{ item }}.pid) 2>/dev/null; then
          kill $(cat /tmp/snmpsim_{{ item }}.pid)
          rm -f /tmp/snmpsim_{{ item }}.pid
        fi
      loop:
        - 1161
        - 1162

    - name: Run snmpsim instances
      ansible.builtin.command: >
        snmpsim-command-responder
        --data-dir=/tmp/data/{{ item }}
        --agent-udpv4-endpoint=127.0.0.1:{{ item }}
        --process-user=nobody
        --process-group=nogroup
        --pid-file=/tmp/snmpsim_{{ item }}.pid
        --logging-method=file:/tmp/snmpsim_{{ item }}.log
        --daemonize
      loop:
        - 1161
        - 1162
